<!-- Updated create-listing.hbs with image upload -->
<div class="container mt-5">
    <h1>Create a Listing</h1>

    {{#if message}}
    <div class="alert alert-{{message.type}} alert-dismissible fade show" role="alert">
        {{message.text}}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {{/if}}

    <!-- Tabs for Product vs Service -->
    <ul class="nav nav-tabs mt-4" id="listingTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link {{#if (or (not listingType) (eq listingType 'product'))}}active{{/if}}" 
                    id="product-tab" data-bs-toggle="tab" data-bs-target="#product" 
                    type="button" role="tab">
                Product Listing
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {{#if (eq listingType 'service')}}active{{/if}}" 
                    id="service-tab" data-bs-toggle="tab" data-bs-target="#service" 
                    type="button" role="tab">
                Service Listing
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3" id="listingTabContent">
        
        <!-- PRODUCT LISTING FORM -->
        <div class="tab-pane fade {{#if (or (not listingType) (eq listingType 'product'))}}show active{{/if}}" 
             id="product" role="tabpanel">
            <form action="/create-listing/product" method="POST" enctype="multipart/form-data" autocomplete="off">
                
                <!-- Product Type Selector -->
                <div class="mb-4">
                    <label class="form-label d-block">Product Type *</label>
                    <div class="btn-group flex-wrap" role="group" aria-label="Product type selection">
                        <input type="radio" class="btn-check" name="productType" id="productTypeSki" value="ski" 
                               {{#if (or (not formData.productType) (eq formData.productType 'ski'))}}checked{{/if}} required>
                        <label class="btn btn-outline-primary" for="productTypeSki">Ski</label>
                        
                        <input type="radio" class="btn-check" name="productType" id="productTypeSnowboard" value="snowboard" 
                               {{#if (eq formData.productType 'snowboard')}}checked{{/if}}>
                        <label class="btn btn-outline-primary" for="productTypeSnowboard">Snowboard</label>
                        
                        <input type="radio" class="btn-check" name="productType" id="productTypeHelmet" value="helmet" 
                               {{#if (eq formData.productType 'helmet')}}checked{{/if}}>
                        <label class="btn btn-outline-primary" for="productTypeHelmet">Helmet</label>
                        
                        <input type="radio" class="btn-check" name="productType" id="productTypeBoots" value="boots" 
                               {{#if (eq formData.productType 'boots')}}checked{{/if}}>
                        <label class="btn btn-outline-primary" for="productTypeBoots">Boots</label>
                        
                        <input type="radio" class="btn-check" name="productType" id="productTypePoles" value="poles" 
                               {{#if (eq formData.productType 'poles')}}checked{{/if}}>
                        <label class="btn btn-outline-primary" for="productTypePoles">Poles</label>
                        
                        <input type="radio" class="btn-check" name="productType" id="productTypeGoggles" value="goggles" 
                               {{#if (eq formData.productType 'goggles')}}checked{{/if}}>
                        <label class="btn btn-outline-primary" for="productTypeGoggles">Goggles</label>
                        
                        <input type="radio" class="btn-check" name="productType" id="productTypeGloves" value="gloves" 
                               {{#if (eq formData.productType 'gloves')}}checked{{/if}}>
                        <label class="btn btn-outline-primary" for="productTypeGloves">Gloves</label>
                        
                        <input type="radio" class="btn-check" name="productType" id="productTypeJackets" value="jackets" 
                               {{#if (eq formData.productType 'jackets')}}checked{{/if}}>
                        <label class="btn btn-outline-primary" for="productTypeJackets">Jackets</label>
                        
                        <input type="radio" class="btn-check" name="productType" id="productTypePants" value="pants" 
                               {{#if (eq formData.productType 'pants')}}checked{{/if}}>
                        <label class="btn btn-outline-primary" for="productTypePants">Pants</label>
                        
                        <input type="radio" class="btn-check" name="productType" id="productTypeOther" value="other" 
                               {{#if (eq formData.productType 'other')}}checked{{/if}}>
                        <label class="btn btn-outline-primary" for="productTypeOther">Other</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="brand" class="form-label">Brand *</label>
                    <select class="form-control" id="brand" name="brand" required>
                        <option value="">Select a brand</option>
                        {{#each brands}}
                        <option value="{{@key}}" data-category="{{this}}" {{#if (eq ../formData.brand @key)}}selected{{/if}}>{{@key}}</option>
                        {{/each}}
                        <!-- Other option - always visible -->
                        <option value="Other" data-category="all" {{#if (eq formData.brand 'Other')}}selected{{/if}}>Other</option>
                    </select>
                </div>

                <!-- Custom brand input (shown when "Other" is selected) -->
                <div class="mb-3" id="customBrandContainer" style="display: none;">
                    <label for="customBrand" class="form-label">Custom Brand *</label>
                    <input type="text" class="form-control" id="customBrand" name="customBrand" 
                           value="{{formData.customBrand}}" maxlength="50" placeholder="Enter brand name">
                </div>

                <div class="mb-3">
                    <label for="model" class="form-label">Model</label>
                    <input type="text" class="form-control" id="model" name="model" 
                           value="{{formData.model}}" maxlength="50">
                </div>

                <div class="mb-3">
                    <label for="productName" class="form-label">Product Name *</label>
                    <input type="text" class="form-control" id="productName" name="productName" 
                           value="{{formData.productName}}" required maxlength="50">
                </div>

                <div class="mb-3">
                    <label for="productDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="productDescription" name="productDescription" 
                              rows="4" maxlength="5000">{{formData.productDescription}}</textarea>
                </div>

                <!-- Ski Dimensions -->
                <div id="skiDimensions" class="row">
                    <div class="col-md-6 mb-3">
                        <label for="skiLength" class="form-label">Ski Length (cm) *</label>
                        <input type="number" class="form-control" id="skiLength" name="skiLength" 
                               value="{{formData.skiLength}}" min="50" max="250" step="0.1" autocomplete="off" inputmode="numeric"
                               placeholder="50 - 250 cm">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="skiWidth" class="form-label">Ski Width (mm) *</label>
                        <input type="number" class="form-control" id="skiWidth" name="skiWidth" 
                               value="{{formData.skiWidth}}" min="40" max="200" step="0.1" autocomplete="off" inputmode="numeric"
                               placeholder="40 - 200 mm">
                    </div>
                </div>

                <!-- Snowboard Dimensions -->
                <div id="snowboardDimensions" class="row" style="display: none;">
                    <div class="col-md-6 mb-3">
                        <label for="snowboardLength" class="form-label">Snowboard Length (cm) *</label>
                        <input type="number" class="form-control" id="snowboardLength" name="snowboardLength" 
                               value="{{formData.snowboardLength}}" min="100" max="200" step="0.1" autocomplete="off" inputmode="numeric"
                               placeholder="100 - 200 cm">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="snowboardWidth" class="form-label">Snowboard Width (mm) *</label>
                        <input type="number" class="form-control" id="snowboardWidth" name="snowboardWidth" 
                               value="{{formData.snowboardWidth}}" min="200" max="300" step="0.1" autocomplete="off" inputmode="numeric"
                               placeholder="200 - 300 mm">
                    </div>
                </div>

                <!-- Helmet Size -->
                <div id="helmetDimensions" class="row" style="display: none;">
                    <div class="col-md-6 mb-3">
                        <label for="helmetSize" class="form-label">Helmet Size (cm) *</label>
                        <input type="number" class="form-control" id="helmetSize" name="helmetSize" 
                               value="{{formData.helmetSize}}" min="48" max="65" step="0.5" autocomplete="off" inputmode="numeric"
                               placeholder="48 - 65 cm">
                        <div class="form-text">Measure around your head, just above your eyebrows</div>
                    </div>
                </div>

                <!-- Boots Fields -->
                <div id="bootsDimensions" style="display: none;">
                    <!-- Informative message about boots -->
                    <div class="alert alert-info mb-3" role="alert">
                        <i class="bi bi-info-circle"></i>
                        <strong>Note:</strong> This section is for <strong>Ski Boots</strong> and <strong>Snowboard Boots</strong> only. 
                        For other types of boots (hiking, work boots, etc.), please use the "Other" tab.
                    </div>
                    
                    <!-- Boot Type Selector -->
                    <div class="mb-3">
                        <label class="form-label d-block">Boot Type *</label>
                        <div class="btn-group" role="group" aria-label="Boot type selection">
                            <input type="radio" class="btn-check" name="bootType" id="bootTypeSki" value="ski" 
                                   {{#if (or (not formData.bootType) (eq formData.bootType 'ski'))}}checked{{/if}}>
                            <label class="btn btn-outline-secondary" for="bootTypeSki">Ski Boots</label>
                            
                            <input type="radio" class="btn-check" name="bootType" id="bootTypeSnowboard" value="snowboard" 
                                   {{#if (eq formData.bootType 'snowboard')}}checked{{/if}}>
                            <label class="btn btn-outline-secondary" for="bootTypeSnowboard">Snowboard Boots</label>
                        </div>
                    </div>
                    
                    <!-- Boot Size -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bootSize" class="form-label">Boot Size (US) *</label>
                            <input type="number" class="form-control" id="bootSize" name="bootSize" 
                                   value="{{formData.bootSize}}" min="3" max="16" step="0.5" 
                                   autocomplete="off" inputmode="numeric"
                                   placeholder="3 - 16 (US)"
                                   oninvalid="this.setCustomValidity('Boot size must be between 3 and 16 (US size)')" 
                                   oninput="this.setCustomValidity('')">
                            <div class="form-text">US shoe size (e.g., 7, 7.5, 8, etc.) Must be between 3 and 16.</div>
                        </div>
                    </div>
                </div>

                <!-- Poles Length -->
                <div id="polesDimensions" class="row" style="display: none;">
                    <div class="col-md-6 mb-3">
                        <label for="polesLength" class="form-label">Pole Length (cm) *</label>
                        <input type="number" class="form-control" id="polesLength" name="polesLength" 
                               value="{{formData.polesLength}}" min="80" max="160" step="1" autocomplete="off" inputmode="numeric"
                               placeholder="80 - 160 cm">
                        <div class="form-text">Length of the pole in centimeters</div>
                    </div>
                </div>

                <!-- Clothing Size (for Goggles, Gloves, Jackets, Pants) -->
                <div id="clothingDimensions" class="row" style="display: none;">
                    <div class="col-md-6 mb-3">
                        <label for="clothingSize" class="form-label">Size *</label>
                        <select class="form-control" id="clothingSize" name="clothingSize">
                            <option value="">Select Size</option>
                            <option value="XS" {{#if (eq formData.clothingSize 'XS')}}selected{{/if}}>XS</option>
                            <option value="S" {{#if (eq formData.clothingSize 'S')}}selected{{/if}}>S</option>
                            <option value="M" {{#if (eq formData.clothingSize 'M')}}selected{{/if}}>M</option>
                            <option value="L" {{#if (eq formData.clothingSize 'L')}}selected{{/if}}>L</option>
                            <option value="XL" {{#if (eq formData.clothingSize 'XL')}}selected{{/if}}>XL</option>
                            <option value="XXL" {{#if (eq formData.clothingSize 'XXL')}}selected{{/if}}>XXL</option>
                            <option value="XXXL" {{#if (eq formData.clothingSize 'XXXL')}}selected{{/if}}>XXXL</option>
                        </select>
                    </div>
                </div>

                <!-- Other Products (no specific fields) -->
                <div id="otherDimensions" style="display: none;">
                    <div class="alert alert-info mb-3" role="alert">
                        <i class="bi bi-info-circle"></i>
                        <strong>Note:</strong> Use this option for other types of gear not listed above.
                    </div>
                </div>

                <div class="mb-3">
                    <label for="price" class="form-label">Price ($) *</label>
                    <input type="number" step="0.01" class="form-control" id="price" name="price" 
                           value="{{formData.price}}" required autocomplete="off" inputmode="decimal"
                           placeholder="$0.01 - $99,999.99">
                </div>

                <!-- IMAGE UPLOAD -->
                <div class="mb-3">
                    <label for="productImages" class="form-label">Product Images (Max 5)</label>
                    <input type="file" class="form-control" id="productImages" name="productImages" 
                           accept="image/*" multiple>
                    <div class="form-text">You can upload up to 5 images. First image will be the primary image.</div>
                </div>

                <div id="productImagePreview" class="mb-3 d-flex flex-wrap gap-2"></div>

                <button type="submit" class="btn btn-primary">Create Product Listing</button>
            </form>
        </div>

        <!-- SERVICE LISTING FORM -->
        <div class="tab-pane fade {{#if (eq listingType 'service')}}show active{{/if}}" 
             id="service" role="tabpanel">
            <form action="/create-listing/service" method="POST" enctype="multipart/form-data" autocomplete="off">
                
                <div class="mb-3">
                    <label for="serviceName" class="form-label">Service Name *</label>
                    <input type="text" class="form-control" id="serviceName" name="serviceName" 
                           value="{{formData.serviceName}}" required>
                </div>

                <div class="mb-3">
                    <label for="serviceDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="serviceDescription" name="serviceDescription" 
                              rows="4">{{formData.serviceDescription}}</textarea>
                </div>

                <div class="mb-3">
                    <label for="servicePrice" class="form-label">Price ($)</label>
                    <input type="number" step="0.01" class="form-control" id="servicePrice" name="price" 
                           value="{{formData.price}}" autocomplete="off" inputmode="decimal"
                           placeholder="$0.01 - $99,999.99 (optional)">
                </div>

                <!-- IMAGE UPLOAD -->
                <div class="mb-3">
                    <label for="serviceImages" class="form-label">Service Images (Max 5)</label>
                    <input type="file" class="form-control" id="serviceImages" name="serviceImages" 
                           accept="image/*" multiple>
                    <div class="form-text">You can upload up to 5 images. First image will be the primary image.</div>
                </div>

                <div id="serviceImagePreview" class="mb-3 d-flex flex-wrap gap-2"></div>

                <button type="submit" class="btn btn-primary">Create Service Listing</button>
            </form>
        </div>

    </div>
</div>

<script>
// Product type toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    // Brand dropdown toggle functionality
    const brandSelect = document.getElementById('brand');
    const customBrandContainer = document.getElementById('customBrandContainer');
    const customBrandInput = document.getElementById('customBrand');
    
    function toggleCustomBrandInput() {
        if (brandSelect && customBrandContainer && customBrandInput) {
            if (brandSelect.value === 'Other') {
                customBrandContainer.style.display = 'block';
                customBrandInput.required = true;
            } else {
                customBrandContainer.style.display = 'none';
                customBrandInput.required = false;
                customBrandInput.value = '';
            }
        }
    }
    
    // Set initial state based on form data
    if (brandSelect) {
        toggleCustomBrandInput();
        brandSelect.addEventListener('change', toggleCustomBrandInput);
    }
    
    // Function to filter brands based on product type
    function filterBrandsByProductType(productType) {
        if (!brandSelect) return;
        
        const selectedBrand = brandSelect.value;
        const allOptions = brandSelect.querySelectorAll('option');
        
        // Map product types to brand categories
        const categoryMap = {
            'ski': ['ski'],
            'snowboard': ['snowboard'],
            'helmet': ['helmet'],
            'boots': ['boots'],
            'goggles': ['goggles'],
            'gloves': ['jackets', 'pants', 'gloves'],
            'jackets': ['jackets', 'pants', 'gloves'],
            'pants': ['jackets', 'pants', 'gloves'],
            'poles': ['poles'],
            'other': ['all'] // Show all brands for "other"
        };
        
        const allowedCategories = categoryMap[productType] || ['all'];
        
        // Show/hide options based on category
        allOptions.forEach(option => {
            if (option.value === '' || option.value === 'Other') {
                // Always show placeholder and "Other" option
                option.style.display = '';
                return;
            }
            
            const categories = option.getAttribute('data-category');
            if (!categories) {
                // If no category attribute, show it (backward compatibility)
                option.style.display = '';
                return;
            }
            
            const categoryList = categories.split(',');
            const shouldShow = allowedCategories.includes('all') || 
                              categoryList.some(cat => allowedCategories.includes(cat.trim()));
            
            option.style.display = shouldShow ? '' : 'none';
        });
        
        // If currently selected brand is hidden, reset to empty
        const selectedOption = brandSelect.querySelector(`option[value="${selectedBrand}"]`);
        if (selectedOption && selectedOption.style.display === 'none' && selectedBrand !== 'Other') {
            brandSelect.value = '';
            // Clear custom brand input if it was "Other"
            if (customBrandInput) {
                customBrandInput.value = '';
            }
        }
    }
    
    const productTypeRadios = document.querySelectorAll('input[name="productType"]');
    const skiDimensions = document.getElementById('skiDimensions');
    const snowboardDimensions = document.getElementById('snowboardDimensions');
    const helmetDimensions = document.getElementById('helmetDimensions');
    const bootsDimensions = document.getElementById('bootsDimensions');
    const polesDimensions = document.getElementById('polesDimensions');
    const clothingDimensions = document.getElementById('clothingDimensions');
    const otherDimensions = document.getElementById('otherDimensions');
    
    const skiLengthInput = document.getElementById('skiLength');
    const skiWidthInput = document.getElementById('skiWidth');
    const snowboardLengthInput = document.getElementById('snowboardLength');
    const snowboardWidthInput = document.getElementById('snowboardWidth');
    const helmetSizeInput = document.getElementById('helmetSize');
    const bootSizeInput = document.getElementById('bootSize');
    const bootTypeSkiInput = document.getElementById('bootTypeSki');
    const bootTypeSnowboardInput = document.getElementById('bootTypeSnowboard');
    const polesLengthInput = document.getElementById('polesLength');
    const clothingSizeInput = document.getElementById('clothingSize');

    let currentProductType = null;
    
    function toggleDimensions() {
        const selectedType = document.querySelector('input[name="productType"]:checked')?.value || 'ski';
        
        // Only clear values if product type actually changed
        const typeChanged = currentProductType !== null && currentProductType !== selectedType;
        currentProductType = selectedType;
        
        // Hide all dimension sections first
        skiDimensions.style.display = 'none';
        snowboardDimensions.style.display = 'none';
        helmetDimensions.style.display = 'none';
        bootsDimensions.style.display = 'none';
        polesDimensions.style.display = 'none';
        clothingDimensions.style.display = 'none';
        otherDimensions.style.display = 'none';
        
        // Remove required from all inputs
        if (skiLengthInput) skiLengthInput.required = false;
        if (skiWidthInput) skiWidthInput.required = false;
        if (snowboardLengthInput) snowboardLengthInput.required = false;
        if (snowboardWidthInput) snowboardWidthInput.required = false;
        if (helmetSizeInput) helmetSizeInput.required = false;
        if (bootSizeInput) bootSizeInput.required = false;
        if (bootTypeSkiInput) bootTypeSkiInput.required = false;
        if (bootTypeSnowboardInput) bootTypeSnowboardInput.required = false;
        if (polesLengthInput) polesLengthInput.required = false;
        if (clothingSizeInput) clothingSizeInput.required = false;
        
        // Only clear values if product type changed (not on initial load or when same type selected)
        if (typeChanged) {
            if (skiLengthInput) skiLengthInput.value = '';
            if (skiWidthInput) skiWidthInput.value = '';
            if (snowboardLengthInput) snowboardLengthInput.value = '';
            if (snowboardWidthInput) snowboardWidthInput.value = '';
            if (helmetSizeInput) helmetSizeInput.value = '';
            if (bootSizeInput) bootSizeInput.value = '';
            if (polesLengthInput) polesLengthInput.value = '';
            if (clothingSizeInput) clothingSizeInput.value = '';
            // Reset boot type radio buttons
            if (bootTypeSkiInput) bootTypeSkiInput.checked = false;
            if (bootTypeSnowboardInput) bootTypeSnowboardInput.checked = false;
        }
        
        // Show and set required for selected type
        if (selectedType === 'ski') {
            if (skiDimensions) skiDimensions.style.display = 'flex';
            if (skiLengthInput) skiLengthInput.required = true;
            if (skiWidthInput) skiWidthInput.required = true;
        } else if (selectedType === 'snowboard') {
            if (snowboardDimensions) snowboardDimensions.style.display = 'flex';
            if (snowboardLengthInput) snowboardLengthInput.required = true;
            if (snowboardWidthInput) snowboardWidthInput.required = true;
        } else if (selectedType === 'helmet') {
            if (helmetDimensions) helmetDimensions.style.display = 'flex';
            if (helmetSizeInput) helmetSizeInput.required = true;
        } else if (selectedType === 'boots') {
            if (bootsDimensions) bootsDimensions.style.display = 'block';
            if (bootSizeInput) bootSizeInput.required = true;
            if (bootTypeSkiInput) bootTypeSkiInput.required = true;
        } else if (selectedType === 'poles') {
            if (polesDimensions) polesDimensions.style.display = 'flex';
            if (polesLengthInput) polesLengthInput.required = true;
        } else if (['goggles', 'gloves', 'jackets', 'pants'].includes(selectedType)) {
            if (clothingDimensions) clothingDimensions.style.display = 'flex';
            if (clothingSizeInput) clothingSizeInput.required = true;
        } else if (selectedType === 'other') {
            if (otherDimensions) otherDimensions.style.display = 'block';
        }
        
        // Filter brands based on selected product type
        filterBrandsByProductType(selectedType);
    }

    // Set initial state (don't clear values on initial load)
    toggleDimensions();
    
    // Add event listeners to radio buttons
    productTypeRadios.forEach(radio => {
        radio.addEventListener('change', toggleDimensions);
    });
    
    // Prevent browser from modifying number inputs while typing
    // This prevents autocomplete/autofill and browser validation from interfering
    const numberInputs = document.querySelectorAll('input[type="number"]');
    numberInputs.forEach(input => {
        // Disable browser autocomplete and autocorrect for number inputs
        input.setAttribute('autocomplete', 'off');
        input.setAttribute('autocorrect', 'off');
        input.setAttribute('autocapitalize', 'off');
        input.setAttribute('spellcheck', 'false');
        
        // Disable scroll wheel from changing number input values
        // This prevents accidental value changes when scrolling over number inputs
        input.addEventListener('wheel', function(e) {
            // Prevent scroll from changing the value
            e.preventDefault();
            return false;
        }, { passive: false });
        
        // Helper function to clamp and round a value
        const clampAndRound = function(inputElement) {
            const valueStr = inputElement.value.trim();
            
            // Skip if empty (let validation handle required fields)
            if (!valueStr) {
                return;
            }
            
            // Parse the current value
            let value = parseFloat(valueStr);
            
            // Skip if not a valid number
            if (isNaN(value) || !isFinite(value)) {
                return;
            }
            
            // Get min, max, and step from attributes
            const minAttr = inputElement.getAttribute('min');
            const maxAttr = inputElement.getAttribute('max');
            const stepAttr = inputElement.getAttribute('step') || '1';
            
            let min = minAttr !== null ? parseFloat(minAttr) : null;
            let max = maxAttr !== null ? parseFloat(maxAttr) : null;
            const step = parseFloat(stepAttr);
            
            // Special handling for price inputs (no min/max in HTML, but validation exists)
            if (inputElement.id === 'price' || inputElement.id === 'servicePrice') {
                min = 0.01;
                max = 99999.99;
            }
            
            // Clamp to min/max bounds
            if (min !== null && value < min) {
                value = min;
            }
            if (max !== null && value > max) {
                value = max;
            }
            
            // Round to nearest step
            if (step > 0) {
                // Handle decimal precision for step
                const stepDecimals = (step.toString().split('.')[1] || '').length;
                const rounded = Math.round(value / step) * step;
                
                // Fix floating point precision issues
                value = parseFloat(rounded.toFixed(stepDecimals));
            }
            
            // Update the input value if it changed
            const newValueStr = value.toString();
            if (newValueStr !== valueStr) {
                inputElement.value = newValueStr;
                
                // Trigger input event to notify any listeners
                inputElement.dispatchEvent(new Event('input', { bubbles: true }));
            }
        };
        
        // Clamp and round values when user exits the field (blur event)
        input.addEventListener('blur', function() {
            clampAndRound(this);
        });
        
        // Also clamp and round when Enter is pressed
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                clampAndRound(this);
                // Blur the field after clamping/rounding
                this.blur();
            }
        });
        
        // Store the value before any potential browser modification
        let previousValue = input.value;
        let previousSelectionStart = 0;
        let previousSelectionEnd = 0;
        
        // Save selection position before input
        input.addEventListener('keydown', function(e) {
            previousSelectionStart = this.selectionStart || 0;
            previousSelectionEnd = this.selectionEnd || 0;
            previousValue = this.value;
        });
        
        // Prevent browser from modifying the value unexpectedly
        input.addEventListener('input', function(e) {
            // If the input is focused and user is typing, allow the change
            // But prevent browser autocomplete/autofill from changing values
            const currentValue = this.value;
            const currentSelectionStart = this.selectionStart || 0;
            
            // If browser moved cursor unexpectedly, try to restore it
            if (this === document.activeElement && 
                Math.abs(currentSelectionStart - (previousSelectionStart + 1)) > 2 &&
                previousSelectionStart > 0) {
                // Browser might have interfered with cursor position
                // Try to restore reasonable position
                setTimeout(() => {
                    const expectedPosition = Math.min(previousSelectionStart + 1, currentValue.length);
                    this.setSelectionRange(expectedPosition, expectedPosition);
                }, 0);
            }
            
            previousValue = currentValue;
        });
        
        // Handle invalid input with custom feedback for boot size
        if (input.id === 'bootSize') {
            input.addEventListener('invalid', function(e) {
                e.preventDefault();
                
                const bootSizeValue = parseFloat(this.value);
                const MIN_BOOT_SIZE = 3;
                const MAX_BOOT_SIZE = 16;
                
                let errorMessage = '';
                if (isNaN(bootSizeValue)) {
                    errorMessage = 'Boot Size must be a valid number.';
                } else if (bootSizeValue < MIN_BOOT_SIZE || bootSizeValue > MAX_BOOT_SIZE) {
                    errorMessage = `Boot Size must be between ${MIN_BOOT_SIZE} and ${MAX_BOOT_SIZE} (US size).`;
                } else {
                    errorMessage = 'Boot Size is required.';
                }
                
                // Show error message using showClientMessage if available, otherwise create alert
                if (typeof showClientMessage === 'function') {
                    showClientMessage('danger', errorMessage);
                    if (typeof markInvalidField === 'function') {
                        markInvalidField(this);
                    }
                } else {
                    // Fallback: create error message container
                    let container = document.getElementById("clientMessageContainer");
                    if (!container) {
                        container = document.createElement("div");
                        container.id = "clientMessageContainer";
                        const form = document.querySelector('form[action="/create-listing/product"]');
                        if (form) {
                            form.insertBefore(container, form.firstChild);
                        }
                    }
                    container.innerHTML = `
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            ${errorMessage}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                    this.classList.add('is-invalid');
                }
                
                this.focus();
            }, true);
        } else {
            // For other number inputs, prevent browser validation while typing
            input.addEventListener('invalid', function(e) {
                e.preventDefault();
            }, true);
        }
        
        // Clear validation state when user starts typing
        input.addEventListener('input', function() {
            if (this.classList.contains('is-invalid')) {
                this.classList.remove('is-invalid');
            }
            // Clear error message container if it exists
            const container = document.getElementById("clientMessageContainer");
            if (container && this.id === 'bootSize') {
                container.innerHTML = '';
            }
        });
    });
});

// Image preview for product images
document.getElementById('productImages')?.addEventListener('change', function(e) {
    const preview = document.getElementById('productImagePreview');
    preview.innerHTML = '';
    
    if (this.files.length > 5) {
        alert('Maximum 5 images allowed');
        this.value = '';
        return;
    }
    
    Array.from(this.files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'position-relative';
            div.innerHTML = `
                <img src="${e.target.result}" style="width: 100px; height: 100px; object-fit: cover;" class="rounded">
                ${index === 0 ? '<span class="badge bg-primary position-absolute top-0 start-0">Primary</span>' : ''}
            `;
            preview.appendChild(div);
        };
        reader.readAsDataURL(file);
    });
});

// Image preview for service images
document.getElementById('serviceImages')?.addEventListener('change', function(e) {
    const preview = document.getElementById('serviceImagePreview');
    preview.innerHTML = '';
    
    if (this.files.length > 5) {
        alert('Maximum 5 images allowed');
        this.value = '';
        return;
    }
    
    Array.from(this.files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'position-relative';
            div.innerHTML = `
                <img src="${e.target.result}" style="width: 100px; height: 100px; object-fit: cover;" class="rounded">
                ${index === 0 ? '<span class="badge bg-primary position-absolute top-0 start-0">Primary</span>' : ''}
            `;
            preview.appendChild(div);
        };
        reader.readAsDataURL(file);
    });
});
</script>
